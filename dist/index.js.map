{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["/**\r\n * Executes an array of Promise-returning functions sequentially.\r\n * @param arr - Array of functions returning Promises.\r\n * @returns Resolves when all Promises complete in sequence.\r\n */\r\nexport const sequence = (arr: Array<() => Promise<any>>) =>\r\n  arr.reduce((prev, job) => prev.then(job), Promise.resolve());\r\n\r\n/**\r\n * Executes an array of Promise-returning functions in parallel.\r\n * @param arr - Array of functions returning Promises.\r\n * @returns Resolves when all Promises complete.\r\n */\r\nexport const parallel = (arr: Array<() => Promise<any>>) => Promise.all(arr.map(job => job()));\r\n\r\nconst tick =\r\n  typeof window !== \"undefined\" && typeof window.requestAnimationFrame === \"function\"\r\n    ? window.requestAnimationFrame\r\n    : (callback: () => void) => setTimeout(callback, 16); // ~60 FPS in node\r\n\r\n/**\r\n * Simple tween.\r\n * @param duration - Duration in milliseconds.\r\n * @param onUpdate - Callback with progress (0 to 1).\r\n * @param signal - Optional AbortSignal to cancel the animation.\r\n * @returns Resolves on completion or cancellation.\r\n */\r\nexport const tween = async (\r\n  duration: number,\r\n  onUpdate: (t: number, aborted?: boolean) => void,\r\n  signal?: AbortSignal\r\n): Promise<void> => {\r\n  const start = performance.now();\r\n  return new Promise<void>(resolve => {\r\n    function step() {\r\n      const now = performance.now();\r\n      const elapsed = now - start;\r\n      const t = Math.min(elapsed / duration, 1);\r\n\r\n      if (signal?.aborted) {\r\n        onUpdate(t, true);\r\n        resolve();\r\n        return;\r\n      }\r\n\r\n      onUpdate(t);\r\n\r\n      if (t < 1) {\r\n        tick(step);\r\n      } else {\r\n        resolve();\r\n      }\r\n    }\r\n\r\n    if (duration <= 0) {\r\n      tick(() => {\r\n        onUpdate(1, signal?.aborted);\r\n        resolve();\r\n      });\r\n    } else {\r\n      step();\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * Delay using a promise.\r\n * @param duration - Duration in milliseconds.\r\n * @param signal - Optional AbortSignal to cancel the delay.\r\n * @returns Resolves on completion or cancellation.\r\n */\r\nexport const delay = async (duration: number, signal?: AbortSignal): Promise<void> => {\r\n  const start = performance.now();\r\n  return new Promise<void>(resolve => {\r\n    function step() {\r\n      const now = performance.now();\r\n      const elapsed = now - start;\r\n      const t = Math.min(elapsed / duration, 1);\r\n\r\n      if (signal?.aborted) {\r\n        resolve();\r\n        return;\r\n      }\r\n\r\n      if (t < 1) {\r\n        tick(step);\r\n      } else {\r\n        resolve();\r\n      }\r\n    }\r\n\r\n    if (duration <= 0) {\r\n      tick(resolve);\r\n    } else {\r\n      step();\r\n    }\r\n  });\r\n};\r\n\r\nexport type StateHandler<State extends string> = (\r\n  next: (state: State) => void,\r\n  exit: () => void\r\n) => Promise<void> | void;\r\n\r\ntype StateConfig<State extends string> = {\r\n  start: StateHandler<State>;\r\n} & {\r\n  [K in State]: StateHandler<State>;\r\n};\r\n\r\n/**\r\n * Micro state machine.\r\n * @param config - States object where each parameter is a state handler.\r\n * @returns Resolves when the state machine exits.\r\n * @example\r\n * await states({\r\n *   async start(next) {\r\n *     console.log(\"Starting...\");\r\n *     next(\"idle\");\r\n *   },\r\n *   async idle(next) {\r\n *     console.log(\"In the idle...\");\r\n *     await delay(500);\r\n *     next(\"end\");\r\n *   },\r\n *   async end(next, exit) {\r\n *     console.log(\"Ending...\");\r\n *     await delay(500);\r\n *     exit();\r\n *    },\r\n * });\r\n */\r\nexport const states = async <State extends string>(config: StateConfig<State>): Promise<void> => {\r\n  return new Promise<void>(resolve => {\r\n    const exit = () => resolve();\r\n    const next = (state: State) => processState(state);\r\n\r\n    const processState = async (state: State) => {\r\n      const stateHandler = config[state];\r\n      if (!stateHandler) {\r\n        throw new Error(`State \"${state}\" is not defined.`);\r\n      }\r\n      await stateHandler(next, exit);\r\n    };\r\n    processState(\"start\" as State);\r\n  });\r\n};\r\n"],"names":[],"mappings":"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"}